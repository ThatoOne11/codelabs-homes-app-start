name: Deploy Supabase Functions & Auth Email Templates

on:
  push:
    branches:
      - main
    paths:
      - "supabase/functions/**"
      - "supabase/email_templates/**"
  workflow_dispatch: # allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ðŸ‘ˆ fetch full history for reliable diffs

      - name: Setup Node.js (for Supabase CLI)
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ----------------------------
      # Detect changed edge functions
      # ----------------------------
      - name: Get changed functions
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RANGE="HEAD^ HEAD"
          else
            RANGE="${{ github.event.before }} ${{ github.sha }}"
          fi

          CHANGED_FUNCS=$(git diff --name-only $RANGE | grep '^supabase/functions/' | cut -d'/' -f3 | uniq)
          echo "changed=$CHANGED_FUNCS" >> $GITHUB_OUTPUT

      - name: Deploy changed Edge Functions
        if: steps.changes.outputs.changed != ''
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "Functions to deploy: ${{ steps.changes.outputs.changed }}"
          for fn in ${{ steps.changes.outputs.changed }}; do
            echo "ðŸš€ Deploying function: $fn"
            npx supabase functions deploy "$fn" --project-ref $PROJECT_ID
          done

      # ----------------------------
      # Detect changed email templates
      # ----------------------------
      - name: Check if email templates changed
        id: email
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RANGE="HEAD^ HEAD"
          else
            RANGE="${{ github.event.before }} ${{ github.sha }}"
          fi

          if git diff --name-only $RANGE | grep -q '^supabase/email_templates/.*\.html$'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync Auth Email Templates
        if: steps.email.outputs.changed == 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "ðŸ“© Updating Auth email templates..."
          npx supabase db push --project-ref $PROJECT_ID
