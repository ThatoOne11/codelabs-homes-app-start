name: "Check Supabase PR Migrations"

on:
Â  pull_request_target:
Â  Â  types: [opened, synchronize, reopened]
Â  Â  paths:
Â  Â  Â  - "supabase/migrations/**"

jobs:
Â  validate_migrations:
Â  Â  runs-on: ubuntu-latest
Â  Â  permissions:
Â  Â  Â  pull-requests: write

Â  Â  steps:
Â  Â  Â  - name: Checkout PR code
Â  Â  Â  Â  uses: actions/checkout@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  ref: ${{ github.event.pull_request.head.sha }}
Â  Â  Â  Â  Â  fetch-depth: 0

Â  Â  Â  - name: Verify Migration Timestamp & Prepare Summary
Â  Â  Â  Â  id: check
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  TARGET_BRANCH="origin/${{ github.base_ref }}"

Â  Â  Â  Â  Â  LATEST_TARGET_MIGRATION_TS=$(git ls-tree -r "$TARGET_BRANCH" --name-only supabase/migrations \
Â  Â  Â  Â  Â  Â  | sort -r | head -n 1 \
Â  Â  Â  Â  Â  Â  | sed -E 's|supabase/migrations/([0-9]+)_.+|\1|' || echo "0")

Â  Â  Â  Â  Â  mapfile -t NEW_MIGRATIONS < <(git diff --name-only --diff-filter=A "$TARGET_BRANCH"...HEAD \
Â  Â  Â  Â  Â  Â  | grep 'supabase/migrations/' || true)

Â  Â  Â  Â  Â  if [ ${#NEW_MIGRATIONS[@]} -eq 0 ]; then
Â  Â  Â  Â  Â  Â  echo "conclusion=success" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo "summary_title=âœ… Supabase Migration Check" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  echo "summary_body<<EOF"
Â  Â  Â  Â  Â  Â  Â  echo "No new migrations detected."
Â  Â  Â  Â  Â  Â  Â  echo "EOF"
Â  Â  Â  Â  Â  Â  } >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  exit 0
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  ERROR_DETAILS=""
Â  Â  Â  Â  Â  HAS_ERROR=false
Â  Â  Â  Â  Â  for file in "${NEW_MIGRATIONS[@]}"; do
Â  Â  Â  Â  Â  Â  [ -z "$file" ] && continue
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  FILENAME=$(basename "$file")
Â  Â  Â  Â  Â  Â  PR_MIGRATION_TS="${FILENAME%%_*}"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if [[ "$PR_MIGRATION_TS" -le "$LATEST_TARGET_MIGRATION_TS" ]]; then
Â  Â  Â  Â  Â  Â  Â  HAS_ERROR=true
Â  Â  Â  Â  Â  Â  Â  ERROR_DETAILS="${ERROR_DETAILS}- \`${FILENAME}\` (Timestamp: ${PR_MIGRATION_TS})"$'\n'
Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if [ "$HAS_ERROR" = true ]; then
Â  Â  Â  Â  Â  Â  echo "conclusion=failure" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo "summary_title=âŒ Supabase Migration Check Failed" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  echo "summary_body<<EOF" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo "The following files have timestamps older than the latest in \`main\` ($LATEST_TARGET_MIGRATION_TS):" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  while IFS= read -r line; do
Â  Â  Â  Â  Â  Â  Â  echo "$line" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  done <<< "$ERROR_DETAILS"
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  echo >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo "ðŸ‘‰ To fix: Merge or Rebase your branch on \`main\` and rename your migration file(s) to a current timestamp." >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo "EOF" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "conclusion=success" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo "summary_title=âœ… Supabase Migration Check Passed" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo "summary_body<<EOF" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo "No conflicts were found. Migrations are ready for merge." >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  Â  echo "EOF" >> "$GITHUB_OUTPUT"
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Find Comment
Â  Â  Â  Â  if: always()
Â  Â  Â  Â  uses: peter-evans/find-comment@v3
Â  Â  Â  Â  id: fc
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  issue-number: ${{ github.event.pull_request.number }}
Â  Â  Â  Â  Â  comment-author: 'github-actions[bot]'
Â  Â  Â  Â  Â  body-includes: Supabase Migration Check

Â  Â  Â  - name: Create or Update PR Comment
Â  Â  Â  Â  if: always()
Â  Â  Â  Â  uses: peter-evans/create-or-update-comment@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  comment-id: ${{ steps.fc.outputs.comment-id }}
Â  Â  Â  Â  Â  issue-number: ${{ github.event.pull_request.number }}
Â  Â  Â  Â  Â  edit-mode: replace
Â  Â  Â  Â  Â  body: |
Â  Â  Â  Â  Â  Â  ### ${{ steps.check.outputs.summary_title }}
Â  Â  Â  Â  Â  Â  ${{ steps.check.outputs.summary_body }}

Â  Â  Â  - name: Report Final Status
Â  Â  Â  Â  if: steps.check.outputs.conclusion == 'failure'
Â  Â  Â  Â  run: exit 1
