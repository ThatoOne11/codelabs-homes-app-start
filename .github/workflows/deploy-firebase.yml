name: (Deploy) Firebase Functions & Rules

on:
  push:
    branches:
      - main
    paths:
      - "firebase/functions/**"
      - "firebase/firestore.rules"
      - "firebase/storage.rules"
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "Optional: specify a commit SHA to deploy"
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "npm"
          cache-dependency-path: firebase/functions/package-lock.json

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Install Function Dependencies
        run: |
          cd firebase/functions
          npm ci

      - name: Detect and Prepare Deployments
        id: deploy_prep
        run: |
          set -euo pipefail

          # 1. Determine Range
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            RANGE="HEAD^..HEAD"
            if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
              RANGE="${{ github.event.inputs.commit_sha }}^..${{ github.event.inputs.commit_sha }}"
            fi
          else
            RANGE="${{ github.event.before }}..${{ github.sha }}"
          fi
          echo "Using git diff range: $RANGE"

          # 2. Get Changed Files
          # (Tr '\n' ' ' makes it a single line space-separated string for the node script)
          CHANGED_FILES=$(git diff --name-only "$RANGE" | tr '\n' ' ' || true)
          echo "Changed files: $CHANGED_FILES"

          # 3. Detect Rules Changes
          if echo "$CHANGED_FILES" | grep -q 'firebase/firestore.rules'; then
            echo "firestore_changed=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q 'firebase/storage.rules'; then
            echo "storage_changed=true" >> $GITHUB_OUTPUT
          fi

          # 4. Smart Function Detection
          # Run the script to find exactly which functions to deploy
          DEPLOY_TARGETS=$(node .github/scripts/resolve-deploy.js "$CHANGED_FILES")

          echo "Calculated function targets: $DEPLOY_TARGETS"
          echo "function_targets=$DEPLOY_TARGETS" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # DEPLOYMENT STEPS
      # ---------------------------------------------------------

      - name: Deploy Cloud Functions
        id: deploy_functions
        if: steps.deploy_prep.outputs.function_targets != ''
        working-directory: ./firebase # Important: Run where firebase.json is
        run: |
          TARGETS="${{ steps.deploy_prep.outputs.function_targets }}"

          if [ "$TARGETS" == "all" ]; then
            echo "ðŸš€ Deploying ALL Cloud Functions..."
            firebase deploy --only functions --non-interactive --force
          else
            echo "ðŸš€ Deploying specific functions ($TARGETS)..."
            firebase deploy --only "$TARGETS" --non-interactive --force
          fi

      - name: Deploy Firestore Rules
        id: deploy_firestore
        if: steps.deploy_prep.outputs.firestore_changed == 'true'
        working-directory: ./firebase
        run: |
          echo "Deploying Firestore Rules..."
          firebase deploy --only firestore:rules --non-interactive

      - name: Deploy Storage Rules
        id: deploy_storage
        if: steps.deploy_prep.outputs.storage_changed == 'true'
        working-directory: ./firebase
        run: |
          echo "Deploying Storage Rules..."
          firebase deploy --only storage --non-interactive

      # ---------------------------------------------------------
      # SUMMARY & NOTIFICATION
      # ---------------------------------------------------------

      - name: Deployment Summary
        if: always()
        id: summary_prep
        run: |
          SUMMARY=""

          # Variables
          FUNC_TARGETS="${{ steps.deploy_prep.outputs.function_targets }}"
          FUNC_OUTCOME="${{ steps.deploy_functions.outcome }}"
          FIRESTORE_OUTCOME="${{ steps.deploy_firestore.outcome }}"
          STORAGE_OUTCOME="${{ steps.deploy_storage.outcome }}"

          # 1. Functions Summary
          if [ "$FUNC_OUTCOME" == "success" ]; then
            # Format targets for display (remove 'functions:' prefix)
            DISPLAY_TARGETS=$(echo "$FUNC_TARGETS" | sed 's/functions://g' | sed 's/,/, /g')
            
            if [ "$FUNC_TARGETS" == "all" ]; then
               SUMMARY+="ALL Cloud Functions Deployed\n"
            else
               SUMMARY+="Cloud Functions Deployed: $DISPLAY_TARGETS\n"
            fi
          elif [ "$FUNC_OUTCOME" == "failure" ]; then
            SUMMARY+="âŒ Cloud Functions Deployment FAILED\n"
          fi

          # 2. Firestore Summary
          if [ "$FIRESTORE_OUTCOME" == "success" ]; then
            SUMMARY+="âœ… Firestore Rules Updated\n"
          elif [ "$FIRESTORE_OUTCOME" == "failure" ]; then
            SUMMARY+="âŒ Firestore Rules Deployment FAILED\n"
          fi

          # 3. Storage Summary
          if [ "$STORAGE_OUTCOME" == "success" ]; then
            SUMMARY+="âœ… Storage Rules Updated\n"
          elif [ "$STORAGE_OUTCOME" == "failure" ]; then
            SUMMARY+="âŒ Storage Rules Deployment FAILED\n"
          fi

          # Fallback
          if [ -z "$SUMMARY" ]; then
            if [ "${{ job.status }}" == "success" ]; then
               SUMMARY="No relevant changes detected. Deployment skipped."
            else
               SUMMARY="âŒ Workflow Failed (Pre-deploy error)"
            fi
          fi

          echo "## ðŸ”¥ Firebase Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo -e "$SUMMARY" >> $GITHUB_STEP_SUMMARY

          SLACK_TEXT="${SUMMARY//$'\n'/\\n}"
          echo "slack_text=$SLACK_TEXT" >> $GITHUB_OUTPUT

      - name: Slack Notification
        uses: slackapi/slack-github-action@v2.1.1
        if: always()
        with:
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          method: chat.postMessage
          payload-templated: true
          payload: |
            {
              "channel": "C0ABX3W93L7",
              "text": "Firebase Deployment: ${{ job.status }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":firebase: Firebase Deployment: ${{ job.status }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Repository: *${{ github.repository }}*\nWorkflow: *${{ github.workflow }}*\nBranch: *${{ github.ref_name }}*\nCommit: `${{ github.sha }}`\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.summary_prep.outputs.slack_text }}"
                  }
                }
              ]
            }
