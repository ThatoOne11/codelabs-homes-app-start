name: (Deploy) Firebase Functions & Rules

on:
  push:
    branches:
      - main
    paths:
      - "firebase/functions/**"
      - "firebase/firestore.rules"
      - "firebase/storage.rules"
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "Optional: specify a commit SHA to deploy"
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write" # Required for google-github-actions/auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "npm"
          cache-dependency-path: firebase/functions/package-lock.json

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Install Function Dependencies
        run: |
          cd firebase/functions
          npm ci

      - name: Detect and Prepare Deployments
        id: deploy_prep
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            RANGE="HEAD^..HEAD"
            if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
              RANGE="${{ github.event.inputs.commit_sha }}^..${{ github.event.inputs.commit_sha }}"
            fi
          else
            RANGE="${{ github.event.before }}..${{ github.sha }}"
          fi
          echo "Using git diff range: $RANGE"

          # Detect Changes
          if git diff --name-only "$RANGE" | grep -q 'firebase/functions/'; then
            echo "functions_changed=true" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only "$RANGE" | grep -q 'firebase/firestore.rules'; then
            echo "firestore_changed=true" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only "$RANGE" | grep -q 'firebase/storage.rules'; then
            echo "storage_changed=true" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # DEPLOYMENT STEPS (Now with IDs)
      # ---------------------------------------------------------

      - name: Deploy Cloud Functions
        id: deploy_functions
        if: steps.deploy_prep.outputs.functions_changed == 'true'
        working-directory: ./firebase # Runs where firebase.json is
        run: |
          echo "Deploying Cloud Functions..."
          firebase deploy --only functions --non-interactive --force

      - name: Deploy Firestore Rules
        id: deploy_firestore
        if: steps.deploy_prep.outputs.firestore_changed == 'true'
        working-directory: ./firebase #  Runs where firebase.json is
        run: |
          echo "Deploying Firestore Rules..."
          firebase deploy --only firestore:rules --non-interactive

      - name: Deploy Storage Rules
        id: deploy_storage
        if: steps.deploy_prep.outputs.storage_changed == 'true'
        working-directory: ./firebase # Runs where firebase.json is
        run: |
          echo "Deploying Storage Rules..."
          firebase deploy --only storage --non-interactive

      # ---------------------------------------------------------
      # SUMMARY & NOTIFICATION
      # ---------------------------------------------------------

      - name: Deployment Summary
        if: always()
        id: summary_prep
        run: |
          SUMMARY=""

          # 1. Functions Check
          if [ "${{ steps.deploy_functions.outcome }}" == "success" ]; then
            SUMMARY+=" Cloud Functions updated (Full Deploy)\n"
          elif [ "${{ steps.deploy_functions.outcome }}" == "failure" ]; then
            SUMMARY+="âŒ Cloud Functions deployment FAILED\n"
          fi

          # 2. Firestore Check
          if [ "${{ steps.deploy_firestore.outcome }}" == "success" ]; then
            SUMMARY+="- Firestore Rules updated\n"
          elif [ "${{ steps.deploy_firestore.outcome }}" == "failure" ]; then
            SUMMARY+="âŒ Firestore Rules deployment FAILED\n"
          fi

          # 3. Storage Check
          if [ "${{ steps.deploy_storage.outcome }}" == "success" ]; then
            SUMMARY+="- Storage Rules updated\n"
          elif [ "${{ steps.deploy_storage.outcome }}" == "failure" ]; then
            SUMMARY+="âŒ Storage Rules deployment FAILED\n"
          fi

          # Fallback if nothing happened
          if [ -z "$SUMMARY" ]; then
            if [ "${{ job.status }}" == "success" ]; then
               SUMMARY="- No changes detected."
            else
               SUMMARY="- Workflow failed."
            fi
          fi

          echo "## ðŸ”¥ Firebase Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo -e "$SUMMARY" >> $GITHUB_STEP_SUMMARY

          SLACK_TEXT="${SUMMARY//$'\n'/\\n}"
          echo "slack_text=$SLACK_TEXT" >> $GITHUB_OUTPUT

      - name: Slack Notification
        uses: slackapi/slack-github-action@v2.1.1
        if: always()
        with:
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          method: chat.postMessage
          payload-templated: true
          payload: |
            {
              "channel": "C0ABX3W93L7",
              "text": "Firebase Deployment: ${{ job.status }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":firebase: Firebase Deployment: ${{ job.status }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Repository: *${{ github.repository }}*\nWorkflow: *${{ github.workflow }}*\nBranch: *${{ github.ref_name }}*\nCommit: `${{ github.sha }}`\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.summary_prep.outputs.slack_text }}"
                  }
                }
              ]
            }
