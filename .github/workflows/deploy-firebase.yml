name: Deploy Firebase Functions & Rules

on:
  push:
    branches:
      - main
    paths:
      - "functions/**"
      - "firestore.rules"
      - "storage.rules"
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "Optional: specify a commit SHA to deploy"
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write" # Required for google-github-actions/auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: "npm"
          cache-dependency-path: functions/package-lock.json

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Install Function Dependencies
        run: |
          cd functions
          npm ci
          # If using TypeScript, uncomment the line below:
          # npm run build

      - name: Detect and Prepare Deployments
        id: deploy_prep
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            RANGE="HEAD^..HEAD"
            if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
              RANGE="${{ github.event.inputs.commit_sha }}^..${{ github.event.inputs.commit_sha }}"
            fi
          else
            RANGE="${{ github.event.before }}..${{ github.sha }}"
          fi
          echo "Using git diff range: $RANGE"

          # Detect Changes
          # 1. Functions (Check if anything in functions/ folder changed)
          if git diff --name-only "$RANGE" | grep -q 'functions/'; then
            echo "functions_changed=true" >> $GITHUB_OUTPUT
            echo "Functions have changed."
          fi

          # 2. Firestore Rules
          if git diff --name-only "$RANGE" | grep -q 'firestore.rules'; then
            echo "firestore_changed=true" >> $GITHUB_OUTPUT
            echo "Firestore Rules have changed."
          fi

          # 3. Storage Rules
          if git diff --name-only "$RANGE" | grep -q 'storage.rules'; then
            echo "storage_changed=true" >> $GITHUB_OUTPUT
            echo "Storage Rules have changed."
          fi

      - name: Deploy Cloud Functions
        if: steps.deploy_prep.outputs.functions_changed == 'true'
        run: |
          echo "ðŸš€ Deploying Cloud Functions..."
          # We deploy all functions to ensure shared dependencies are updated correctly
          firebase deploy --only functions --non-interactive --force

      - name: Deploy Firestore Rules
        if: steps.deploy_prep.outputs.firestore_changed == 'true'
        run: |
          echo "ðŸ“œ Deploying Firestore Rules..."
          firebase deploy --only firestore:rules --non-interactive

      - name: Deploy Storage Rules
        if: steps.deploy_prep.outputs.storage_changed == 'true'
        run: |
          echo "ðŸ“¦ Deploying Storage Rules..."
          firebase deploy --only storage --non-interactive

      - name: Deployment Summary
        if: always()
        id: summary_prep
        run: |
          SUMMARY=""

          if [ "${{ steps.deploy_prep.outputs.functions_changed }}" == "true" ]; then
            SUMMARY+="- Cloud Functions updated (Full Group Deploy)\n"
          fi

          if [ "${{ steps.deploy_prep.outputs.firestore_changed }}" == "true" ]; then
            SUMMARY+="- Firestore Rules updated\n"
          fi

          if [ "${{ steps.deploy_prep.outputs.storage_changed }}" == "true" ]; then
            SUMMARY+="- Storage Rules updated\n"
          fi

          if [ -z "$SUMMARY" ]; then
            SUMMARY="- No significant changes detected. No deployments were necessary."
          fi

          echo "## ðŸ”¥ Firebase Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo -e "$SUMMARY" >> $GITHUB_STEP_SUMMARY

          # Escape newlines for Slack JSON payload compatibility
          SLACK_TEXT="${SUMMARY//$'\n'/\\n}"
          echo "slack_text=$SLACK_TEXT" >> $GITHUB_OUTPUT

      - name: Slack Notification
        uses: slackapi/slack-github-action@v2.1.1
        if: always()
        with:
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          method: chat.postMessage
          payload-templated: true
          payload: |
            {
              "channel": "C0ABX3W93L7",
              "text": "Deployment Status: ${{ job.status }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Firebase Deployment: ${{ job.status }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Workflow: *${{ github.workflow }}*\nBranch: *${{ github.ref_name }}*\nCommit: `${{ github.sha }}`\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.summary_prep.outputs.slack_text }}"
                  }
                }
              ]
            }
